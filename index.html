<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zecure Inspeções - Painel Técnico</title>
<link rel="preload" href="zecurelogo.png" as="image">

<!-- jsPDF + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
:root {
  --verde-zecure: #00ff66;
  --fundo-escuro: #0e1a1f;
  --cinza-card: #1b2a31;
  --cinza-claro: #223138;
  --texto: #ffffff;
  --borda: #1f3a40;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Roboto, sans-serif;}
body{background: var(--fundo-escuro); color: var(--texto); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;}
.container, .painel{width: 100%; max-width: 500px; background: var(--cinza-card); padding: 25px; border-radius: 12px; box-shadow: 0 0 25px rgba(0,0,0,0.5); text-align: center; transition: all 0.3s ease;}
h2{text-align:center;color: var(--verde-zecure); margin-bottom:15px;font-size:1.8rem;}
input, select, textarea, button{width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border:none; background: var(--cinza-claro); color: var(--texto); font-size: 0.95rem;}
textarea{resize: vertical; min-height: 100px;}
label{display:block; margin-top:10px; color: var(--verde-zecure); font-weight: bold; text-align:left;}
button{background: var(--verde-zecure); color: #000; padding: 12px; margin-top: 20px; width: 100%; border:none; border-radius:6px; cursor:pointer; transition:0.3s;}
button:hover{background: #00e05a;}
.photo-list{display: flex; flex-wrap: wrap; gap: 5px; margin-top:5px; justify-content:center;}
.photo-list img{width:70px; height:70px; object-fit:cover; border-radius:6px; border:1px solid var(--borda);}
.hidden{display:none;}
.logo-login{width:150px; margin-bottom:15px;}
.header-panel {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
.btn-sair {width: auto; padding: 8px 15px; margin: 0; background: #ff4444;}
.btn-sair:hover {background: #ff2222;}
.localizacao-container {margin: 10px 0;}
.coords-box {display: flex; gap: 10px; align-items: center;}
.btn-mapa {width: auto; padding: 5px 10px; margin: 0; font-size: 0.9rem;}
#coordenadas {background: var(--cinza-claro); padding: 8px; border-radius: 4px; flex: 1;}
@media(max-width:720px){input, select, textarea, button{font-size:0.9rem;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="container">
  <img src="zecurelogo.png" alt="Logo Zecure" class="logo-login">
  <h2>Acesso Técnico</h2>
  <input type="text" id="usuario" placeholder="Usuário">
  <input type="password" id="senha" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL DE INSPEÇÃO -->
<div id="painel" class="painel hidden">
  <div class="header-panel">
    <h2>Ficha de Inspeção</h2>
    <button onclick="sair()" class="btn-sair">Sair</button>
  </div>

  <label>Nome do Técnico</label>
  <input type="text" id="nomeTecnico" placeholder="Nome do técnico responsável" readonly>

  <label>Data e Hora</label>
  <input type="text" id="dataHora" readonly>

  <label>Equipamento</label>
  <input type="text" id="equipamento" placeholder="Ex: Bomba de recalque, gerador...">

  <label>Tipo de Inspeção</label>
  <select id="tipo">
    <option value="Preventiva">Preventiva</option>
    <option value="Corretiva">Corretiva</option>
  </select>

  <label>Fotos Antes</label>
  <input type="file" id="fotoAntes" multiple accept="image/*" onchange="previewPhotos('fotoAntes','previewAntes')">
  <div id="previewAntes" class="photo-list"></div>

  <label>Descrição do Serviço / Ocorrência</label>
  <textarea id="descricao"></textarea>

  <label>Fotos Depois</label>
  <input type="file" id="fotoDepois" multiple accept="image/*" onchange="previewPhotos('fotoDepois','previewDepois')">
  <div id="previewDepois" class="photo-list"></div>

  <label>Observações / Necessidade de Compra</label>
  <textarea id="compra"></textarea>

  <button onclick="verificarEGerarPDF()">Gerar PDF</button>

  <div class="localizacao-container">
    <label>Localização Atual</label>
    <div class="coords-box">
      <span id="coordenadas">Aguardando...</span>
      <button onclick="abrirMapa()" class="btn-mapa">Ver no Mapa</button>
    </div>
  </div>
</div>

<script>
window.jsPDF = window.jspdf.jsPDF;

const USERS = { 'Marcos':'Vila2025','Haniel':'Vila2025','Daniel':'Vila2025','Josue':'Vila2025' };
let userLocation = null;

// ===== LOGIN =====
function login() {
    const user = document.getElementById('usuario').value.trim();
    const pass = document.getElementById('senha').value.trim();
    if(USERS[user] && USERS[user]===pass){
        document.getElementById('login').classList.add('hidden');
        document.getElementById('painel').classList.remove('hidden');
        document.getElementById('dataHora').value = new Date().toLocaleString('pt-BR');
        document.getElementById('nomeTecnico').value = user;
        getLocation();
    } else { alert('Usuário ou senha incorretos.'); }
}

// ===== LOCALIZAÇÃO =====
function getLocation(){
    if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(pos=>{
            userLocation={latitude:pos.coords.latitude, longitude:pos.coords.longitude};
            document.getElementById('coordenadas').textContent = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
        }, err=>{
            console.error(err);
            document.getElementById('coordenadas').textContent = 'Localização indisponível';
        });
    }
}

// ===== PREVIEW FOTOS =====
function previewPhotos(inputId, containerId){
    const input=document.getElementById(inputId);
    const container=document.getElementById(containerId);
    container.innerHTML='';
    [...input.files].forEach(file=>{
        const img=document.createElement('img');
        img.src=URL.createObjectURL(file);
        container.appendChild(img);
    });
}

// ===== PRELOAD LOGO =====
async function preloadLogo(){
    return new Promise((resolve,reject)=>{
        const img=new Image();
        img.onload=()=>resolve(canvasToDataURL(img));
        img.onerror=reject;
        img.src='zecurelogo.png';
    });
}
function canvasToDataURL(img){
    const canvas=document.createElement('canvas');
    canvas.width=img.width; canvas.height=img.height;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0);
    return canvas.toDataURL('image/png');
}

// ===== READ FILE TO DATAURL =====
function readFileToDataURL(file, timeoutMs=7000){
    return new Promise(resolve=>{
        const reader=new FileReader();
        let done=false;
        const t=setTimeout(()=>{ if(!done){ done=true; resolve(null); } }, timeoutMs);
        reader.onerror=()=>{ if(!done){ done=true; clearTimeout(t); resolve(null); }};
        reader.onload=(e)=>{ if(!done){ done=true; clearTimeout(t); resolve(e.target.result); }};
        reader.readAsDataURL(file);
    });
}

// Função para processar imagem de forma otimizada
async function processImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        const timeout = setTimeout(() => resolve(null), 5000);
        
        reader.onload = (e) => {
            clearTimeout(timeout);
            resolve(e.target.result);
        };
        
        reader.onerror = () => {
            clearTimeout(timeout);
            resolve(null);
        };
        
        reader.readAsDataURL(file);
    });
}

// Função principal de geração do PDF
async function gerarPDF() {
    try {
        // Validação
        const campos = ['nomeTecnico', 'equipamento', 'descricao'];
        if (campos.some(id => !document.getElementById(id).value.trim())) {
            alert('Preencha todos os campos obrigatórios: Nome, Equipamento e Descrição');
            return;
        }

        // Configuração inicial do PDF
        const doc = new jspdf.jsPDF();
        const margin = 15;
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        let y = margin;

        // Constantes de cores
        const VERDE_ZECURE = [0, 255, 102];
        const FUNDO_ESCURO = [14, 26, 31];
        const CINZA_CARD = [27, 42, 49];

        // Cabeçalho preto para logo
        doc.setFillColor(...FUNDO_ESCURO);
        doc.rect(0, 0, pageWidth, 60, 'F');

        // Logo centralizada em fundo preto
        try {
            const logo = await preloadLogo();
            const logoW = 40;
            doc.addImage(logo, 'PNG', (pageWidth - logoW)/2, margin, logoW, logoW);
            y = margin + logoW + 15;
        } catch(e) {
            console.warn('Erro logo:', e);
            y = 70;
        }

        // Título
        doc.setTextColor(...VERDE_ZECURE);
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('RELATÓRIO DE INSPEÇÃO', pageWidth/2, y, {align: 'center'});
        y += 20;

        // Box de informações com fundo escuro
        doc.setFillColor(...CINZA_CARD);
        doc.roundedRect(margin, y, pageWidth - 2*margin, 55, 3, 3, 'F');

        // Dados do formulário
        const data = {
            tecnico: document.getElementById('nomeTecnico').value,
            equipamento: document.getElementById('equipamento').value,
            tipo: document.getElementById('tipo').value,
            data: new Date().toLocaleString('pt-BR'),
            local: userLocation ? 
                `${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}` : 
                'Não disponível'
        };

        // Informações com alinhamento consistente
        doc.setTextColor(255);
        doc.setFontSize(11);
        const infoY = y + 12;
        const colX = margin + 8;

        // Helper para texto com label
        function addLabeledText(label, text, yPos) {
            doc.setFont('helvetica', 'bold');
            doc.text(label, colX, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(text, colX + 25, yPos);
        }

        addLabeledText('Técnico:', data.tecnico, infoY);
        addLabeledText('Data:', data.data, infoY + 10);
        addLabeledText('Equip:', data.equipamento, infoY + 20);
        addLabeledText('Tipo:', data.tipo, infoY + 30);
        addLabeledText('Local:', data.local, infoY + 40);

        y += 65;

        // Descrição
        doc.setTextColor(0);
        doc.setFillColor(...VERDE_ZECURE, 0.1);
        doc.roundedRect(margin, y, pageWidth - 2*margin, 12, 2, 2, 'F');
        doc.setFont('helvetica', 'bold');
        doc.text('DESCRIÇÃO DO SERVIÇO', margin + 5, y + 8);
        y += 20;

        // Texto da descrição
        doc.setFont('helvetica', 'normal');
        const descLines = doc.splitTextToSize(
            document.getElementById('descricao').value, 
            pageWidth - 2*margin - 6
        );
        doc.text(descLines, margin + 3, y);
        y += descLines.length * 7 + 15;

        // Função para adicionar imagens em grid
        async function addImages(files, title) {
            if (!files.length) return;
            
            if (y > pageHeight - 60) {
                doc.addPage();
                y = margin;
            }

            // Título da seção
            doc.setFillColor(...VERDE_ZECURE, 0.1);
            doc.roundedRect(margin, y, pageWidth - 2*margin, 12, 2, 2, 'F');
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin + 5, y + 8);
            y += 20;

            const images = Array.from(files).slice(0, 4);
            const imgW = 85;
            const imgH = 60;
            const colGap = 8;
            const rowGap = 10;

            for (let i = 0; i < images.length; i++) {
                const col = i % 2;
                const row = Math.floor(i / 2);
                
                if (y + (imgH + rowGap) > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }

                const x = margin + col * (imgW + colGap);
                const imgY = y + row * (imgH + rowGap);

                try {
                    const dataUrl = await processImage(images[i]);
                    if (dataUrl) {
                        // Borda verde
                        doc.setDrawColor(...VERDE_ZECURE);
                        doc.setLineWidth(0.5);
                        doc.rect(x, imgY, imgW, imgH);
                        doc.addImage(dataUrl, 'JPEG', x, imgY, imgW, imgH);
                    }
                } catch(e) {
                    console.warn('Erro ao processar imagem:', e);
                    doc.setDrawColor(...VERDE_ZECURE);
                    doc.rect(x, imgY, imgW, imgH);
                }
            }

            y += Math.ceil(images.length / 2) * (imgH + rowGap) + 10;
        }

        // Adiciona fotos
        await addImages(document.getElementById('fotoAntes').files, 'FOTOS - ANTES');
        await addImages(document.getElementById('fotoDepois').files, 'FOTOS - DEPOIS');

        // Observações (se houver)
        const obs = document.getElementById('compra').value.trim();
        if (obs) {
            if (y > pageHeight - 60) {
                doc.addPage();
                y = margin;
            }
            
            doc.setFillColor(...VERDE_ZECURE, 0.1);
            doc.roundedRect(margin, y, pageWidth - 2*margin, 12, 2, 2, 'F');
            doc.setFont('helvetica', 'bold');
            doc.text('OBSERVAÇÕES', margin + 5, y + 8);
            y += 20;

            doc.setFont('helvetica', 'normal');
            const obsLines = doc.splitTextToSize(obs, pageWidth - 2*margin - 6);
            doc.text(obsLines, margin + 3, y);
        }

        // Rodapé em todas as páginas
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            
            // Linha verde
            doc.setDrawColor(...VERDE_ZECURE);
            doc.setLineWidth(0.5);
            doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);
            
            // Nome da empresa
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(...VERDE_ZECURE);
            doc.text('Zecure - Soluções em Segurança', pageWidth/2, pageHeight - 12, {align: 'center'});
            
            // Número da página
            doc.setFontSize(8);
            doc.text(`Página ${i} de ${pageCount}`, pageWidth - margin, pageHeight - 10);
        }

        // Salva o PDF
        doc.save(`Inspecao_${data.tecnico.replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`);

    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao gerar PDF. Por favor, tente novamente.');
    }
}

// Função de verificação e geração
function verificarEGerarPDF() {
    gerarPDF().catch(err => {
        console.error('Erro:', err);
        alert('Ocorreu um erro ao gerar o PDF. Tente novamente.');
    });
}

function sair(){ document.getElementById('painel').classList.add('hidden'); document.getElementById('login').classList.remove('hidden'); }
function abrirMapa(){ if(userLocation) window.open(`https://www.google.com/maps?q=${userLocation.latitude},${userLocation.longitude}`,'_blank'); else alert('Localização não disponível'); }
</script>

</body>
</html>
